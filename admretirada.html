<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Retiradas</title>
    <style>
        :root {
            --primary: #1a2035;
            --secondary: #4a6cf7;
            --text: #ffffff;
            --card-bg: #2a3244;
            --positive: #4CAF50;
            --negative: #F44336;
            --withdrawal: #FF9800;
            --processing: #2196F3;
            --pending: #FFC107;
            --background: #0f172a;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--background);
            color: var(--text);
            margin: 0;
            padding: 0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--secondary);
        }
        
        .header h1 {
            color: var(--secondary);
            margin: 0;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logout-btn {
            background-color: var(--negative);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .logout-btn:hover {
            opacity: 0.9;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .pending-value {
            color: var(--pending);
        }
        
        .processing-value {
            color: var(--processing);
        }
        
        .approved-value {
            color: var(--positive);
        }
        
        .rejected-value {
            color: var(--negative);
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .filters {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .search-box {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid var(--card-bg);
            background-color: var(--card-bg);
            color: var(--text);
            width: 250px;
        }
        
        .filter-options {
            display: flex;
            gap: 10px;
        }
        
        .filter-option {
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            background-color: var(--card-bg);
        }
        
        .filter-option.active {
            background-color: var(--secondary);
            color: white;
        }
        
        .withdrawals-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .withdrawals-table th {
            background-color: var(--secondary);
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        .withdrawals-table td {
            padding: 12px;
            border-bottom: 1px solid var(--card-bg);
        }
        
        .withdrawals-table tr:hover {
            background-color: rgba(74, 108, 247, 0.1);
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .status-pending {
            background-color: rgba(255, 193, 7, 0.2);
            color: var(--pending);
        }
        
        .status-processing {
            background-color: rgba(33, 150, 243, 0.2);
            color: var(--processing);
        }
        
        .status-approved {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--positive);
        }
        
        .status-rejected {
            background-color: rgba(244, 67, 54, 0.2);
            color: var(--negative);
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .process-btn {
            background-color: var(--processing);
            color: white;
        }
        
        .approve-btn {
            background-color: var(--positive);
            color: white;
        }
        
        .reject-btn {
            background-color: var(--negative);
            color: white;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid rgba(74, 108, 247, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--secondary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }
        
        .page-btn {
            padding: 8px 12px;
            background-color: var(--card-bg);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text);
        }
        
        .page-btn.active {
            background-color: var(--secondary);
            color: white;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--secondary);
        }
        
        .modal-title {
            color: var(--secondary);
            margin: 0;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5em;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-control {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: var(--primary);
            color: var(--text);
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-secondary {
            background-color: #666;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10.325 4.31731C10.751 2.56099 13.249 2.56099 13.675 4.31731C13.95 5.45193 15.25 5.99038 16.247 5.38285C17.7913 4.44239 19.5576 6.2087 18.6172 7.75295C18.0096 8.74995 18.5481 10.05 19.6827 10.325C21.439 10.751 21.439 13.249 19.6827 13.675C18.5481 13.95 18.0096 15.25 18.6172 16.247C19.5576 17.7913 17.7913 19.5576 16.247 18.6172C15.25 18.0096 13.95 18.5481 13.675 19.6827C13.249 21.439 10.751 21.439 10.325 19.6827C10.05 18.5481 8.74995 18.0096 7.75295 18.6172C6.2087 19.5576 4.44239 17.7913 5.38285 16.247C5.99038 15.25 5.45193 13.95 4.31731 13.675C2.56099 13.249 2.56099 10.751 4.31731 10.325C5.45193 10.05 5.99038 8.74995 5.38285 7.75295C4.44239 6.2087 6.2087 4.44239 7.75295 5.38285C8.74995 5.99038 10.05 5.45193 10.325 4.31731Z" stroke="#4a6cf7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M15 12C15 13.6569 13.6569 15 12 15C10.3431 15 9 13.6569 9 12C9 10.3431 10.3431 9 12 9C13.6569 9 15 10.3431 15 12Z" stroke="#4a6cf7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Painel Admin - Retiradas
            </h1>
            <button class="logout-btn" onclick="logout()">Sair</button>
        </div>
        
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-label">Total Retiradas</div>
                <div class="stat-value" id="total-withdrawals">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Pendentes</div>
                <div class="stat-value pending-value" id="pending-withdrawals">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Processando</div>
                <div class="stat-value processing-value" id="processing-withdrawals">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Concluídas</div>
                <div class="stat-value approved-value" id="approved-withdrawals">0</div>
            </div>
        </div>
        
        <div class="filters">
            <input type="text" class="search-box" id="search-input" placeholder="Pesquisar por nome, telefone...">
            
            <div class="filter-options">
                <div class="filter-option active" onclick="filterWithdrawals('all')">Todas</div>
                <div class="filter-option" onclick="filterWithdrawals('pending')">Pendentes</div>
                <div class="filter-option" onclick="filterWithdrawals('processing')">Processando</div>
                <div class="filter-option" onclick="filterWithdrawals('success')">Aprovadas</div>
                <div class="filter-option" onclick="filterWithdrawals('rejected')">Rejeitadas</div>
            </div>
        </div>
        
        <div id="withdrawals-container">
            <div class="loading">
                <div class="spinner"></div>
                <p>Carregando retiradas...</p>
            </div>
        </div>
        
        <div class="pagination" id="pagination">
            <!-- Pagination will be added here dynamically -->
        </div>
    </div>
    
    <!-- Modal for processing/approving/rejecting -->
    <div class="modal" id="action-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Ação</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body">
                <div class="form-group">
                    <label for="action-notes">Observações</label>
                    <textarea id="action-notes" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" id="modal-confirm-btn" onclick="confirmAction()">Confirmar</button>
            </div>
        </div>
    </div>
    
    <script>
    const API_WITHDRAWAL_BASE = 'https://685839af21f5d3463e578873.mockapi.io/Retirada/';
    const ITEMS_PER_PAGE = 10;
    
    let allWithdrawals = [];
    let currentWithdrawals = [];
    let currentPage = 1;
    let currentFilter = 'all';
    let currentSearch = '';
    let currentAction = null;
    let currentWithdrawalId = null;
    let currentApiIndex = null;
    
    document.addEventListener('DOMContentLoaded', async function() {
        // Removida a verificação de login
        await loadAllWithdrawals();
    });
    
    async function loadAllWithdrawals() {
        const container = document.getElementById('withdrawals-container');
        container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Carregando retiradas...</p></div>';
        
        try {
            // Busca retiradas em todas as APIs (1-20)
            const withdrawalRequests = [];
            for (let i = 1; i <= 20; i++) {
                withdrawalRequests.push(fetch(`${API_WITHDRAWAL_BASE}${i}`));
            }
            
            const responses = await Promise.allSettled(withdrawalRequests);
            allWithdrawals = [];
            
            for (let i = 0; i < responses.length; i++) {
                const response = responses[i];
                if (response.status === 'fulfilled' && response.value.ok) {
                    try {
                        const data = await response.value.json();
                        if (Array.isArray(data)) {
                            // Add API index to each withdrawal for updating later
                            data.forEach(withdrawal => {
                                withdrawal.apiIndex = i + 1; // API number (1-20)
                                allWithdrawals.push(withdrawal);
                            });
                        }
                    } catch (error) {
                        console.error(`Erro ao processar API de retirada ${i + 1}:`, error);
                    }
                }
            }
            
            // Ordena por data (mais recente primeiro)
            allWithdrawals.sort((a, b) => new Date(b.createdAt || b.data) - new Date(a.createdAt || a.data));
            
            updateStats();
            filterWithdrawals(currentFilter);
            
        } catch (error) {
            console.error('Erro ao carregar retiradas:', error);
            container.innerHTML = '<div class="record-card"><p>Ocorreu um erro ao carregar as retiradas.</p></div>';
        }
    }
    
    function updateStats() {
        document.getElementById('total-withdrawals').textContent = allWithdrawals.length;
        document.getElementById('pending-withdrawals').textContent = allWithdrawals.filter(w => w.status === 'pending').length;
        document.getElementById('processing-withdrawals').textContent = allWithdrawals.filter(w => w.status === 'processing').length;
        document.getElementById('approved-withdrawals').textContent = allWithdrawals.filter(w => w.status === 'success' || w.status === 'completed').length;
    }
    
    function filterWithdrawals(filter) {
        currentFilter = filter;
        currentPage = 1;
        
        // Update active filter button
        document.querySelectorAll('.filter-option').forEach(opt => {
            opt.classList.remove('active');
            if (opt.textContent.toLowerCase().includes(filter)) {
                opt.classList.add('active');
            }
        });
        
        // Apply filter
        let filtered = allWithdrawals;
        
        if (filter === 'pending') {
            filtered = allWithdrawals.filter(w => w.status === 'pending');
        } else if (filter === 'processing') {
            filtered = allWithdrawals.filter(w => w.status === 'processing');
        } else if (filter === 'success') {
            filtered = allWithdrawals.filter(w => w.status === 'success' || w.status === 'completed');
        } else if (filter === 'rejected') {
            filtered = allWithdrawals.filter(w => w.status === 'rejected');
        }
        
        // Apply search if any
        if (currentSearch) {
            const searchTerm = currentSearch.toLowerCase();
            filtered = filtered.filter(w => 
                (w.name && w.name.toLowerCase().includes(searchTerm)) ||
                (w.phone && w.phone.toLowerCase().includes(searchTerm)) ||
                (w.ibanDetails && w.ibanDetails.toLowerCase().includes(searchTerm))
            );
        }
        
        currentWithdrawals = filtered;
        displayWithdrawals();
    }
    
    function displayWithdrawals() {
        const container = document.getElementById('withdrawals-container');
        
        if (currentWithdrawals.length === 0) {
            container.innerHTML = '<div class="record-card"><p>Nenhuma retirada encontrada.</p></div>';
            document.getElementById('pagination').innerHTML = '';
            return;
        }
        
        // Calculate pagination
        const totalPages = Math.ceil(currentWithdrawals.length / ITEMS_PER_PAGE);
        const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, currentWithdrawals.length);
        const pageWithdrawals = currentWithdrawals.slice(startIndex, endIndex);
        
        // Create table
        let html = `
            <table class="withdrawals-table">
                <thead>
                    <tr>
                        <th>Usuário</th>
                        <th>Detalhes</th>
                        <th>Valor</th>
                        <th>Status</th>
                        <th>Data</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        pageWithdrawals.forEach(withdrawal => {
            const date = new Date(withdrawal.createdAt || withdrawal.data);
            const formattedDate = date.toLocaleString('pt-PT', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(',', '');
            
            const valorFormatado = withdrawal.amount.toLocaleString('pt-PT', {
                style: 'decimal',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            // Status badge
            let statusBadge;
            if (withdrawal.status === 'pending') {
                statusBadge = '<span class="status-badge status-pending">Pendente</span>';
            } else if (withdrawal.status === 'processing') {
                statusBadge = '<span class="status-badge status-processing">Processando</span>';
            } else if (withdrawal.status === 'success' || withdrawal.status === 'completed') {
                statusBadge = '<span class="status-badge status-approved">Aprovado</span>';
            } else if (withdrawal.status === 'rejected') {
                statusBadge = '<span class="status-badge status-rejected">Rejeitado</span>';
            } else {
                statusBadge = '<span class="status-badge">' + withdrawal.status + '</span>';
            }
            
            // Action buttons
            let actionButtons = '';
            if (withdrawal.status === 'pending') {
                actionButtons = `
                    <button class="action-btn process-btn" onclick="openActionModal('process', '${withdrawal.id}', ${withdrawal.apiIndex})">Processar</button>
                    <button class="action-btn approve-btn" onclick="openActionModal('approve', '${withdrawal.id}', ${withdrawal.apiIndex})">Aprovar</button>
                    <button class="action-btn reject-btn" onclick="openActionModal('reject', '${withdrawal.id}', ${withdrawal.apiIndex})">Rejeitar</button>
                `;
            } else if (withdrawal.status === 'processing') {
                actionButtons = `
                    <button class="action-btn approve-btn" onclick="openActionModal('approve', '${withdrawal.id}', ${withdrawal.apiIndex})">Aprovar</button>
                    <button class="action-btn reject-btn" onclick="openActionModal('reject', '${withdrawal.id}', ${withdrawal.apiIndex})">Rejeitar</button>
                `;
            } else {
                actionButtons = '-';
            }
            
            // User info
            const userName = withdrawal.name || 'Usuário ' + (withdrawal.phone || withdrawal.id);
            const firstLetter = userName.charAt(0).toUpperCase();
            
            html += `
                <tr>
                    <td>
                        <div class="user-info">
                            <div class="user-avatar">${firstLetter}</div>
                            <div>
                                <div>${userName}</div>
                                <div style="font-size: 0.8em; opacity: 0.8;">${withdrawal.phone || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div><strong>Conta:</strong> ${withdrawal.ibanDetails || 'Não especificada'}</div>
                        <div><strong>Taxa:</strong> ${withdrawal.fee || '0'} Kz</div>
                    </td>
                    <td>${valorFormatado} Kz</td>
                    <td>${statusBadge}</td>
                    <td>${formattedDate}</td>
                    <td>${actionButtons}</td>
                </tr>
            `;
        });
        
        html += `
                </tbody>
            </table>
        `;
        
        container.innerHTML = html;
        
        // Create pagination
        let paginationHtml = '';
        if (totalPages > 1) {
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `
                    <button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>
                `;
            }
        }
        document.getElementById('pagination').innerHTML = paginationHtml;
    }
    
    function goToPage(page) {
        currentPage = page;
        displayWithdrawals();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Search functionality
    document.getElementById('search-input').addEventListener('input', function(e) {
        currentSearch = e.target.value;
        filterWithdrawals(currentFilter);
    });
    
    // Modal functions
    function openActionModal(action, withdrawalId, apiIndex) {
        currentAction = action;
        currentWithdrawalId = withdrawalId;
        currentApiIndex = apiIndex;
        
        const modal = document.getElementById('action-modal');
        const title = document.getElementById('modal-title');
        const confirmBtn = document.getElementById('modal-confirm-btn');
        
        if (action === 'process') {
            title.textContent = 'Processar Retirada';
            confirmBtn.textContent = 'Processar';
            confirmBtn.className = 'btn btn-primary';
            confirmBtn.style.backgroundColor = '#2196F3';
        } else if (action === 'approve') {
            title.textContent = 'Aprovar Retirada';
            confirmBtn.textContent = 'Aprovar';
            confirmBtn.className = 'btn btn-primary';
            confirmBtn.style.backgroundColor = '#4CAF50';
        } else if (action === 'reject') {
            title.textContent = 'Rejeitar Retirada';
            confirmBtn.textContent = 'Rejeitar';
            confirmBtn.className = 'btn btn-primary';
            confirmBtn.style.backgroundColor = '#F44336';
        }
        
        document.getElementById('action-notes').value = '';
        modal.style.display = 'flex';
    }
    
    function closeModal() {
        document.getElementById('action-modal').style.display = 'none';
    }
    
    async function confirmAction() {
        const notes = document.getElementById('action-notes').value;
        const withdrawal = allWithdrawals.find(w => w.id === currentWithdrawalId && w.apiIndex === currentApiIndex);
        
        if (!withdrawal) {
            alert('Retirada não encontrada!');
            closeModal();
            return;
        }
        
        try {
            let newStatus;
            let successMessage;
            
            if (currentAction === 'process') {
                newStatus = 'processing';
                successMessage = 'Retirada marcada como processando!';
            } else if (currentAction === 'approve') {
                newStatus = 'success';
                successMessage = 'Retirada aprovada com sucesso!';
            } else if (currentAction === 'reject') {
                newStatus = 'rejected';
                successMessage = 'Retirada rejeitada!';
            }
            
            // Update the withdrawal
            const updatedWithdrawal = {
                ...withdrawal,
                status: newStatus,
                adminNotes: notes,
                processedAt: new Date().toISOString()
            };
            
            // Remove apiIndex before sending
            delete updatedWithdrawal.apiIndex;
            
            const response = await fetch(`${API_WITHDRAWAL_BASE}${currentApiIndex}/${currentWithdrawalId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updatedWithdrawal)
            });
            
            if (response.ok) {
                alert(successMessage);
                closeModal();
                await loadAllWithdrawals(); // Refresh data
            } else {
                throw new Error('Failed to update withdrawal');
            }
        } catch (error) {
            console.error('Error updating withdrawal:', error);
            alert('Ocorreu um erro ao atualizar a retirada.');
        }
    }
    
    // Removida a função de logout
</script>
</body>
</html>